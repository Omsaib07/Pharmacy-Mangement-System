{% extends "layout.html" %}
{% block body %}

<div class="container mt-5">
    <h2 class="mb-4">Order Medicines and Products</h2>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <form action="{{ url_for('medicine') }}" method="post">
        <div class="row">
            <!-- Personal Information -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Personal Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="mid" class="form-label">Medical ID</label>
                            <input type="number" class="form-control" id="mid" name="mid" required>
                        </div>
                        <div class="mb-3">
                            <label for="name" class="form-label">Medical Name</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Section -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Order Details</h5>
                    </div>
                    <div class="card-body">
                        <!-- Medicines Section -->
                        <div class="mb-4">
                            <label class="form-label">Select Medicines</label>
                            <select class="form-select mb-2" name="medicines" id="medicines">
                                <option value="">Select a medicine</option>
                                {% for medicine in medicines %}
                                <option value="{{ medicine.sno }}" data-quantity="{{ medicine.quantity }}" 
                                        data-price="{{ medicine.price if medicine.price else 0 }}">
                                    {{ medicine.medicine }} (Available: {{ medicine.quantity }})
                                </option>
                                {% endfor %}
                            </select>
                            <div class="input-group">
                                <input type="number" class="form-control" name="medicine_quantity" 
                                       id="medicine_quantity" placeholder="Quantity" min="1">
                                <span class="input-group-text" id="medicine-max"></span>
                            </div>
                        </div>

                        <!-- Products Section -->
                        <div class="mb-3">
                            <label class="form-label">Select Products</label>
                            <select class="form-select mb-2" name="products" id="products">
                                <option value="">Select a product</option>
                                {% for product in products %}
                                <option value="{{ product.sno }}" data-quantity="{{ product.quantity }}"
                                        data-price="{{ product.price if product.price else 0 }}">
                                    {{ product.product }} (Available: {{ product.quantity }})
                                </option>
                                {% endfor %}
                            </select>
                            <div class="input-group">
                                <input type="number" class="form-control" name="product_quantity" 
                                       id="product_quantity" placeholder="Quantity" min="1">
                                <span class="input-group-text" id="product-max"></span>
                            </div>
                        </div>

                        <!-- Order Summary -->
                        <div class="mt-4 p-3 bg-light rounded">
                            <h6 class="mb-3">Order Summary</h6>
                            <div id="orderSummary">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Selected Medicine:</span>
                                    <span id="selectedMedicine">-</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Selected Product:</span>
                                    <span id="selectedProduct">-</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2 fw-bold">
                                    <span>Total Items:</span>
                                    <span id="totalItems">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Tables -->
        <div class="row mb-4">
            <!-- Medicines Inventory -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Available Medicines</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Medicine Name</th>
                                        <th>Quantity</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for medicine in all_medicines %}
                                    <tr>
                                        <td>{{ medicine.medicine }}</td>
                                        <td>{{ medicine.quantity }}</td>
                                        <td>
                                            {% if medicine.quantity > 0 %}
                                            <span class="badge bg-success">In Stock</span>
                                            {% else %}
                                            <span class="badge bg-danger">Out of Stock</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Inventory -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Available Products</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Product Name</th>
                                        <th>Quantity</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for product in all_products %}
                                    <tr>
                                        <td>{{ product.product }}</td>
                                        <td>{{ product.quantity }}</td>
                                        <td>
                                            {% if product.quantity > 0 %}
                                            <span class="badge bg-success">In Stock</span>
                                            {% else %}
                                            <span class="badge bg-danger">Out of Stock</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mb-5">
            <button type="submit" class="btn btn-primary btn-lg px-5">Place Order</button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const medicineSelect = document.getElementById('medicines');
    const productSelect = document.getElementById('products');
    const medicineQuantityInput = document.getElementById('medicine_quantity');
    const productQuantityInput = document.getElementById('product_quantity');
    const medicineMax = document.getElementById('medicine-max');
    const productMax = document.getElementById('product-max');
    const midInput = document.getElementById('mid');
    const nameInput = document.getElementById('name');
    
    // Summary elements
    const selectedMedicine = document.getElementById('selectedMedicine');
    const selectedProduct = document.getElementById('selectedProduct');
    const totalItems = document.getElementById('totalItems');
    const totalPriceElement = document.createElement('div'); // Create a new element for total price
    totalPriceElement.classList.add('d-flex', 'justify-content-between', 'mb-2', 'fw-bold');
    totalPriceElement.innerHTML = `<span>Total Price:</span><span id="totalPrice">₹0</span>`;
    document.getElementById('orderSummary').appendChild(totalPriceElement);

    // MID verification
    let timeoutId;
    midInput.addEventListener('input', function() {
        const mid = this.value.trim();
        clearTimeout(timeoutId);

        timeoutId = setTimeout(() => {
            if (mid) {
                fetch(`/verify_mid/${mid}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            midInput.classList.remove('is-invalid');
                            midInput.classList.add('is-valid');
                            // Removed auto-filling of nameInput
                            nameInput.disabled = false; // Optional: Keep enabled if users should enter it manually
                        } else {
                            midInput.classList.remove('is-valid');
                            midInput.classList.add('is-invalid');
                            nameInput.disabled = false; // Allow manual entry if the ID is invalid
                        }
                    });
            }
        }, 300);
    });

    function updateMaxQuantity(selectElement, quantityInput, maxSpan) {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        if (selectedOption.value) {
            const maxQuantity = selectedOption.dataset.quantity;
            quantityInput.max = maxQuantity;
            quantityInput.placeholder = `Enter quantity`;
            maxSpan.textContent = `Max: ${maxQuantity}`;
        } else {
            quantityInput.value = '';
            quantityInput.max = '';
            maxSpan.textContent = '';
        }
    }

    function updateOrderSummary() {
        const medicineOption = medicineSelect.options[medicineSelect.selectedIndex];
        const productOption = productSelect.options[productSelect.selectedIndex];
        const medicineQty = parseInt(medicineQuantityInput.value) || 0;
        const productQty = parseInt(productQuantityInput.value) || 0;
        const medicinePrice = parseFloat(medicineOption.dataset.price) || 0;
        const productPrice = parseFloat(productOption.dataset.price) || 0;

        // Calculate total price
        const totalPrice = (medicinePrice * medicineQty) + (productPrice * productQty);

        selectedMedicine.textContent = medicineOption.value ? 
            `${medicineOption.text.split(' (')[0]} × ${medicineQty}` : '-';
        selectedProduct.textContent = productOption.value ? 
            `${productOption.text.split(' (')[0]} × ${productQty}` : '-';
        totalItems.textContent = medicineQty + productQty;
        document.getElementById('totalPrice').textContent = `₹${totalPrice.toFixed(2)}`;
    }

    // Event listeners
    medicineSelect.addEventListener('change', () => {
        updateMaxQuantity(medicineSelect, medicineQuantityInput, medicineMax);
        updateOrderSummary();
    });
    
    productSelect.addEventListener('change', () => {
        updateMaxQuantity(productSelect, productQuantityInput, productMax);
        updateOrderSummary();
    });

    medicineQuantityInput.addEventListener('input', updateOrderSummary);
    productQuantityInput.addEventListener('input', updateOrderSummary);

    // Form validation
    document.querySelector('form').addEventListener('submit', function(e) {
        const medicineSelected = medicineSelect.value !== '';
        const productSelected = productSelect.value !== '';
        const medicineQty = parseInt(medicineQuantityInput.value) || 0;
        const productQty = parseInt(productQuantityInput.value) || 0;

        if (!medicineSelected && !productSelected) {
            e.preventDefault();
            alert('Please select at least one medicine or product.');
            return;
        }

        if ((medicineSelected && medicineQty === 0) || (productSelected && productQty === 0)) {
            e.preventDefault();
            alert('Please enter quantity for selected items.');
            return;
        }

        if (!confirm('Are you sure you want to place this order?')) {
            e.preventDefault();
        }
    });
});
</script>

{% endblock %}