{% extends "layout.html" %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
{% endblock %}

{% block body %}
  <!-- Page Header -->
  <header class="masthead mb-0">
    <div class="overlay"></div>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10 text-center">
          <div class="page-heading">
            <h1 class="display-4 text-white font-weight-bold">Medicines and Products</h1>
            <p class="lead text-white">Do you have questions? We have answers!</p>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Flash Messages -->
  {% with messages=get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="container mt-4">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Main Content -->
  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-lg-8 col-md-10">
        <form name="sentMessage" id="contactForm" action="/medicines" method="post" novalidate>
          
          <!-- Medical ID and Name -->
          <div class="form-group floating-label-form-group controls">
            <label for="mid">Medical ID</label>
            <input type="text" name="mid" class="form-control" placeholder="Enter Medical ID" id="mid" required>
          </div>

          <div class="form-group floating-label-form-group controls">
            <label for="name">Name</label>
            <input type="text" name="name" class="form-control" placeholder="Enter Medical Name" id="name" required>
          </div>

          <!-- Email -->
          <div class="form-group floating-label-form-group controls">
            <label for="email">Email ID</label>
            <input type="email" name="email" class="form-control" placeholder="Enter your email ID" id="email" required>
          </div>

          <!-- Medicines Dropdown and Quantity -->
          <div class="row">
            <div class="col-md-6">
              <div class="form-group floating-label-form-group controls">
                <label for="medicines">Select Medicine</label>
                <select name="medicines" class="form-control" id="medicines" required>
                  <option value="">-- Select Medicine --</option>
                  {% for medicine in medicines %}
                    <option value="{{ medicine.sno }}" data-quantity="{{ medicine.quantity }}">
                      {{ medicine.medicine }} (Available: {{ medicine.quantity }})
                    </option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group floating-label-form-group controls">
                <label for="medicine_quantity">Quantity</label>
                <input type="number" name="medicine_quantity" class="form-control" placeholder="Enter quantity" id="medicine_quantity" required min="1">
                <small class="text-danger" id="medicine-error"></small>
              </div>
            </div>
          </div>

          <!-- Products Dropdown and Quantity -->
          <div class="row">
            <div class="col-md-6">
              <div class="form-group floating-label-form-group controls">
                <label for="products">Select Product</label>
                <select name="products" class="form-control" id="products" required>
                  <option value="">-- Select Product --</option>
                  {% for product in products %}
                    <option value="{{ product.sno }}" data-quantity="{{ product.quantity }}">
                      {{ product.product }} (Available: {{ product.quantity }})
                    </option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group floating-label-form-group controls">
                <label for="product_quantity">Quantity</label>
                <input type="number" name="product_quantity" class="form-control" placeholder="Enter quantity" id="product_quantity" required min="1">
                <small class="text-danger" id="product-error"></small>
              </div>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="form-group text-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg px-5" id="sendMessageButton">Submit Order</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Inventory Display Section -->
    <div class="row mt-5">
      <!-- Medicines Inventory -->
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Available Medicines</h4>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Medicine Name</th>
                    <th>Quantity</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for medicine in all_medicines %}
                  <tr>
                    <td>{{ medicine.medicine }}</td>
                    <td>{{ medicine.quantity }}</td>
                    <td>
                      {% if medicine.quantity > 0 %}
                        <span class="badge badge-success">In Stock</span>
                      {% else %}
                        <span class="badge badge-danger">Out of Stock</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Products Inventory -->
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Available Products</h4>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for product in all_products %}
                  <tr>
                    <td>{{ product.product }}</td>
                    <td>{{ product.quantity }}</td>
                    <td>
                      {% if product.quantity > 0 %}
                        <span class="badge badge-success">In Stock</span>
                      {% else %}
                        <span class="badge badge-danger">Out of Stock</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <hr>

  <!-- JavaScript Libraries -->
  <script src="{{ url_for('static', filename='vendor/jquery/jquery.min.js') }}"></script>
  <script src="{{ url_for('static', filename='vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>

  <!-- Custom Scripts -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
    const medicineSelect = document.getElementById('medicines');
    const productSelect = document.getElementById('products');
    const medicineQuantity = document.getElementById('medicine_quantity');
    const productQuantity = document.getElementById('product_quantity');
    const medicineError = document.getElementById('medicine-error');
    const productError = document.getElementById('product-error');
    const form = document.getElementById('contactForm');

    // Function to validate quantity
    function validateQuantity(select, quantityInput, errorElement) {
        // If nothing is selected, consider it valid (optional)
        if (!select.value) {
            if (!quantityInput.value) {
                return true;
            }
            errorElement.textContent = "Please select an item first";
            return false;
        }

        // If item is selected, quantity is required
        if (!quantityInput.value) {
            errorElement.textContent = "Please enter quantity";
            return false;
        }

        const selectedOption = select.options[select.selectedIndex];
        const availableQuantity = parseInt(selectedOption.dataset.quantity);
        const requestedQuantity = parseInt(quantityInput.value);

        if (isNaN(requestedQuantity) || requestedQuantity <= 0) {
            errorElement.textContent = "Please enter a valid quantity";
            return false;
        }

        if (requestedQuantity > availableQuantity) {
            errorElement.textContent = `Maximum available quantity is ${availableQuantity}`;
            return false;
        }

        errorElement.textContent = "";
        return true;
    }

    // Add event listeners for quantity validation
    medicineQuantity.addEventListener('input', () => {
        validateQuantity(medicineSelect, medicineQuantity, medicineError);
    });

    productQuantity.addEventListener('input', () => {
        validateQuantity(productSelect, productQuantity, productError);
    });

    medicineSelect.addEventListener('change', () => {
        if (!medicineSelect.value) {
            medicineQuantity.value = '';
        }
        validateQuantity(medicineSelect, medicineQuantity, medicineError);
    });

    productSelect.addEventListener('change', () => {
        if (!productSelect.value) {
            productQuantity.value = '';
        }
        validateQuantity(productSelect, productQuantity, productError);
    });

    // Form submission handling
    form.addEventListener('submit', function(event) {
        event.preventDefault();

        const isMedicineValid = validateQuantity(medicineSelect, medicineQuantity, medicineError);
        const isProductValid = validateQuantity(productSelect, productQuantity, productError);

        // Check if at least one item is selected and valid
        const hasMedicine = medicineSelect.value && medicineQuantity.value;
        const hasProduct = productSelect.value && productQuantity.value;

        if (!hasMedicine && !hasProduct) {
            flash("Please select at least one medicine or product to order.", "danger");
            return;
        }

        if (isMedicineValid && isProductValid) {
            if (confirm('Are you sure you want to place this order?')) {
                this.submit();
            }
        }
    });
});
// Add this to your existing script section
document.addEventListener('DOMContentLoaded', function() {
    const midInput = document.getElementById('mid');
    const nameInput = document.getElementById('name');
    const form = document.getElementById('contactForm');
    let timeoutId;

    midInput.addEventListener('input', function() {
        const mid = this.value.trim();
        clearTimeout(timeoutId);

        // Add a small delay to prevent too many requests
        timeoutId = setTimeout(() => {
            if (mid) {
                // Make an AJAX request to verify the MID
                fetch(`/verify_mid/${mid}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            midInput.classList.remove('is-invalid');
                            midInput.classList.add('is-valid');
                            if (data.name) {
                                nameInput.value = data.name;
                                nameInput.disabled = true;
                            }
                        } else {
                            midInput.classList.remove('is-valid');
                            midInput.classList.add('is-invalid');
                            nameInput.value = '';
                            nameInput.disabled = false;
                        }
                    });
            }
        }, 300);
    });
});
  </script>
{% endblock %}